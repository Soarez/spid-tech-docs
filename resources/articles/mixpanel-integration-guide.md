:title Mixpanel analytics integration guide
:frontpage
:body

In order to offer seamless Mixpanel tracking across multiple services and SPiD,
the SPiD user must be identified as soon as possible. To do this, the
[JS SDK](/sdks/javascript/) should be loaded and initialized prior to any event
tracking. If no SPiD user is found (the user is not logged in), the SDK will
return a unique visitor ID that can be used to track events. This visitor ID
**must** be used with every event tracked by the client service through
Mixpanel. As soon as the user logs in (or registers), SPiD will connect the
visitor ID with the actual user. When tracking events on the client's behalf,
SPiD will use the same ID.

### User identification sequence diagram

[![Sequence diagram: Identifying the visitor](/images/identifying_the_visitor.png)](/images/identifying_the_visitor.png)

## Managing User-Specific Properties or Traits

Mixpanel supports tracking of
[user-specific properties](https://mixpanel.com/docs/managing-users/managing-user_specific-properties)
on events and people tracking. In order to append these properties to all events
tracked when the user is redirected to SPiD for login/signup or payment flows,
the client service needs to relay these properties to SPiD. This can be done
client side via the [JS SDK](/sdks/javascript/) or through our
[REST-based APIs](/endpoints/). If done client-side via the JS SDK, SPiD will
add these properties to all events generated by SPiD for that visitor. If the
visitor is a SPiD user or registers as a SPiD user in the process, these
properties will be added to any event generated, regardless of whether the user
is logged in or not (not all events are triggered by the users themselves).

User traits can be managed through the REST-API:
[Create](/endpoints/POST/user/{userId}/traits/),
[list](/endpoints/GET/user/{userId}/traits/), and
[delete](/endpoints/DELETE/user/{userId}/trait/{trait}/).

### Logging traits for users

[![Sequence diagram: Passing visitor user traits to spid via the JS SDK](/images/passing_visitor_user_traits_to_spid_via_the_js_sdk.png)](/images/passing_visitor_user_traits_to_spid_via_the_js_sdk.png)

## The traits JSON object

The format of the JSON object consists of one or more key/value pairs where keys
must be strings and values can be strings, booleans, numbers or a JSON array.
See
[Mixpanel's property data types](https://mixpanel.com/docs/properties-or-segments/property-data-types)
for a list of supported types.

### Example JSON object

```js
{ "Subscribed since": "2012-11-20",
  "Newsletter subscriber": true,
  "Goals reached": 12,
  "Account type": "Personal"
}
```

The traits JSON object must then be signed with the client's signature secret
and base64url encoded before passing this data to SPiD client side.
[Signing](#signing-your-traits-json-object) helps prevent tampering of user
traits by a third party.

The traits object can be updated and queried through the following endpoints:

- [`GET` /user/{userId}/traits](/endpoints/GET/user/{userId}/traits/)
    List current traits
- [`POST` /user/{userId}/traits](/endpoints/POST/user/{userId}/traits/)
    Add or update traits
- [`DELETE` /user/{userId}/traits/{trait}](/endpoints/DELETE/user/{userId}/trait/{trait}/)
    Delete a trait by property name

## Events tracked by SPiD

SPiD will automatically add some profile data to events. These properties should
not be added as traits by the client, as they will be ignored (in favor of the
user's actual profile data). This keeps profile data in events from going stale.

Properties added by SPiD to all events:

- Version (Platform version)
- Revision (Platform revision)
- SPiD ID (The SPiD user id)
- Client (Client alias/name, not client id)
- ip (User's ip in order for Mixpanel to derive country, city, etc)
- User agent (Not used by Mixpanel on server side requests, but we send it anyway)
- Age
- Gender
- User status
- Registered (When the user registered)
- Tracking ref ([Client provided visitor reference](/tracking-parameters/))
- Tracking tag ([Client provided tag parameter](/tracking-parameters/), used for custom order tracking)
- Flow (payment or signup)

In addition we will save specific data on each event based on the event type. A
complete overview follows below:

- Accept agreement
- Verify email
- Login
- Logout
- Migration completed
- Migration started
- Verify phone
- Signup completed
- Signup started
- Verify email sent
- Choose payment method
- Choose product
- Order complete
- Order authorized
- Confirm * payment identifier
- Denied purchase, multisale disallowed
- Prior access to product
- Receipt sent
- Password changed
- Change password notification email sent
- Secondary email added
- Secondary email added notification email sent
- Device fingerprint tracked on user
- Back to client
- Page viewed
- Click to view agreement
- Access check

## SPiD - Page viewed : page_id

<table class="table table-hover">
  <thead>
    <tr>
      <th>Page id</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>about</td>
      <td>About page.</td>
    </tr>
    <tr>
      <td>accept terms</td>
      <td>Step to accept terms of use agreement under login/payment flow.</td>
    </tr>
    <tr>
      <td>edit payment agreement</td>
      <td>Payment agreement administration in account section.</td>
    </tr>
    <tr>
      <td>authenticate</td>
      <td>Re-authenticate page when idle to long under login/payment flow.</td>
    </tr>
    <tr>
      <td>authorize</td>
      <td>Step to authorize a client access to a user's profile (oauth) under login/payment flow.</td>
    </tr>
    <tr>
      <td>change password</td>
      <td>Change password page under account section.</td>
    </tr>
    <tr>
      <td>choose payment method</td>
      <td>Choose payment method page under login/payment flow.</td>
    </tr>
    <tr>
      <td>choose product</td>
      <td>Choose product page under login/payment flow.</td>
    </tr>
    <tr>
      <td>creditcard register</td>
      <td>Register credit card page under account section.</td>
    </tr>
    <tr>
      <td>creditcards</td>
      <td>Credit cards overview under account section.</td>
    </tr>
    <tr>
      <td>delete account</td>
      <td>Delete account page.</td>
    </tr>
    <tr>
      <td>delete email</td>
      <td>Delete email page under account section.</td>
    </tr>
    <tr>
      <td>delete payment identifier</td>
      <td>Delete payment methods page under account section.</td>
    </tr>
    <tr>
      <td>delete phone</td>
      <td>Delete cellphone page under account section.</td>
    </tr>
    <tr>
      <td>emails</td>
      <td>Manage emails.</td>
    </tr>
    <tr>
      <td>enter payment details</td>
      <td>Enter payment details page under login/payment flow.</td>
    </tr>
    <tr>
      <td>error</td>
      <td>Error page.</td>
    </tr>
    <tr>
      <td>forgot password</td>
      <td>Forgot password page.</td>
    </tr>
    <tr>
      <td>login</td>
      <td>Login page under login/payment flow.</td>
    </tr>
    <tr>
      <td>notifications</td>
      <td>Notifications page.</td>
    </tr>
    <tr>
      <td>phones</td>
      <td>Manage cellphones page under account section.</td>
    </tr>
    <tr>
      <td>delete payment preference</td>
      <td>Delete payment preference page under account section.</td>
    </tr>
    <tr>
      <td>edit payment preference</td>
      <td>Edit payment preference page under account section.</td>
    </tr>
    <tr>
      <td>payment preferences</td>
      <td>Payment preferences page under account section.</td>
    </tr>
    <tr>
      <td>primary email</td>
      <td>Manage primary email page under account section.</td>
    </tr>
    <tr>
      <td>privacy</td>
      <td>Privacy page.</td>
    </tr>
    <tr>
      <td>products</td>
      <td>Products overview under account section.</td>
    </tr>
    <tr>
      <td>purchase history</td>
      <td>Purchase history page under account section.</td>
    </tr>
    <tr>
      <td>receipt</td>
      <td>Show receipt page under login/payment flow.</td>
    </tr>
    <tr>
      <td>redeem</td>
      <td>Redeem voucher start page under account section.</td>
    </tr>
    <tr>
      <td>required fields</td>
      <td>Step to get required fields under login/payment flow.</td>
    </tr>
    <tr>
      <td>reset password</td>
      <td>Reset password page.</td>
    </tr>
    <tr>
      <td>update profile</td>
      <td>Update profile page under account section.</td>
    </tr>
    <tr>
      <td>save profile</td>
      <td>Save profile page under account section.</td>
    </tr>
    <tr>
      <td>signup</td>
      <td>Signup page under login/payment flow.</td>
    </tr>
    <tr>
      <td>subscription</td>
      <td>Subscription detail page under account section.</td>
    </tr>
    <tr>
      <td>subscription edit</td>
      <td>Subscription edit action page under account section.</td>
    </tr>
    <tr>
      <td>subscriptions</td>
      <td>Subscriptions overview under account section.</td>
    </tr>
    <tr>
      <td>summary</td>
      <td>Summary page of an users account details.</td>
    </tr>
    <tr>
      <td>survey</td>
      <td>Subscription survey page under account section.</td>
    </tr>
    <tr>
      <td>terms</td>
      <td>Display terms of agreement.</td>
    </tr>
    <tr>
      <td>verify</td>
      <td>Verify email page.</td>
    </tr>
    <tr>
      <td>verify signup</td>
      <td>Verify email page under signup flow.</td>
    </tr>
    <tr>
      <td>verify email</td>
      <td>Verify email page under account section.</td>
    </tr>
    <tr>
      <td>verify phone</td>
      <td>Verify cellphone page under account section.</td>
    </tr>
    <tr>
      <td>unknown error</td>
      <td>Unknown error page.</td>
    </tr>
    <tr>
      <td>paylink_not_available_to_user_error</td>
      <td>Paylink not available to user error page.</td>
    </tr>
    <tr>
      <td>paylink_not_found error</td>
      <td>Paylink not found error page.</td>
    </tr>
    <tr>
      <td>paylink_locked error</td>
      <td>Paylink locked error page.</td>
    </tr>
    <tr>
      <td>paylink_used error</td>
      <td>Paylink used error page.</td>
    </tr>
    <tr>
      <td>paylink_expired error</td>
      <td>Paylink expired error page.</td>
    </tr>
    <tr>
      <td>cookies error</td>
      <td>Browser is missing cookie support error page.</td>
    </tr>
    <tr>
      <td>unknown error</td>
      <td>Unknown error page.</td>
    </tr>
  </tbody>
</table>

## Traits and People analytics in Mixpanel

SPiD does not have any traits. Only additional data provided by clients will be
saved as traits and posted on both events and people data in addition to the
properties above. The only SPiD provided profile data posted to People
analytics, in addition to the client provided traits are:

- **Locale** - the user language settings in SPiD
- **Birthday** - if invalid: undisclosed
- **Last authenticated**
- **Last login**

**NOTE:** This information cannot be overwritten by client traits.

## Implementing Mixpanel tracking in conjunction with SPiD

To implement Mixpanel tracking, you need a token, an API key and a secret. These
are provided by SPiD when new clients are created. There are three steps to
enable Mixpanel tracking for your site:

1. Install the Mixpanel library
2. Identify the visitor via the SPiD SDK
3. Track events using the provided SPiD visitor unique id

It is recommended to read through the
[Mixpanel documentation](https://mixpanel.com/docs/) and research which events
to track, and which funnels to implement before pushing events to Mixpanel.

### 1. Installing the Mixpanel library

We recommend using the Mixpanel JavaScript library although there are
[other implementations](https://mixpanel.com/docs/integration-libraries) too.

Paste this snippet just before the `</head>` end tag of your page:

```html
<!-- start Mixpanel --><script>(function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;a=e.createElement("script");a.type="text/javascript";a.async=!0;a.src=("https:"===e.location.protocol?"https:":"http:")+'//cdn.mxpnl.com/libs/mixpanel-2.2.min.js';f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f);b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==
typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");for(g=0;g<i.length;g++)f(c,i[g]);
b._i.push([a,e,d])};b.__SV=1.2}})(document,window.mixpanel||[]);
mixpanel.init("{YOUR MIXPANEL TOKEN}");</script><!-- end Mixpanel -->
```

Add the SPiD SDK in the same manner (example uses the Norwegian staging
environment):

```html
<script src="https://stage.payment.schibsted.no/js/spid-sdk-1.7.2.js"></script>
```

[SPiD JavaScript SDK details](/sdks/javascript/).

### 2. Identify the visitor via the SPiD SDK

When the page has loaded, subscribe to the "auth.visitor" event. This event is
triggered when SPiD identifies the current visitor and the SDK is initialized.
When the user is identified, you can identify the user with Mixpanel by calling
`mixpanel.identify(SPID_VISITOR_ID)`, and optionally add custom traits to the
current visitor by calling the SPiD JS SDK function
`VGS.setTraits(SIGNED_JSON_OBJECT)`.

Place the following code in a `script` block right before the closing `</body>`
tag, or in a
[DOMContentLoaded event handler](https://developer.mozilla.org/en-US/docs/Web/Reference/Events/DOMContentLoaded)
(e.g. `$(document).ready(function () { /* Here */ })` if using jQuery).

```js
VGS.Event.subscribe('auth.visitor', function(data) {
    mixpanel.identify(data.uid);
    var signedData = 'UKpcW_4cVs2V2X1jnK-SrwVOWWphFKExv85sLfgA6jw.eyJ0ZXN0IjoiOSIsImFsZ29yaXRobSI6IkhNQUMtU0hBMjU2In0';
    VGS.setTraits(signedData, function(data) {});
});

VGS.init({
    client_id: '{YOUR STAGE CLIENT ID}',
    server: 'stage.payment.schibsted.no',
    prod: false,
    logging: true,
    status:true
});
```

### 3. Track events using the provided SPiD unique visitor id

```js
// your own tracking
mixpanel.track('Viewed campaign page', {'campaign': 'Sommerkampanje'});
```

## Signing your traits JSON object

We use the same signature scheme that is provided by all responses from SPiD to
the JS SDK. The signature string is a concatenation of a base64url
encoded HMAC-256 hashed signature, hashed with your client signature secret, of
the JSON object provided, a dot (.) and the base64url encoded version of your
provided JSON object. It looks like this:

```text
zOJ7x_oA3EnL4CB5AsgONtWfdF2r_N6c-aLZTaGy-z8.eyJTdWJzY3JpYmVkIHNpbmNlIjoiMjAxMi0xMS0yMCIsIk5ld3NsZXR0ZXIgc3Vic2NyaWJlciI6dHJ1ZSwiR29hbHMgcmVhY2hlZCI6MTIsIkFjY291bnQgdHlwZSI6IlBlcnNvbmFsIiwiYWxnb3JpdGhtIjoiSE1BQy1TSEEyNTYiLCJ0IjoxMzcyMTUwMjU3LjExfQ
```

The signed data has two parts:

```text
<signature>.<data>
```

To sign the object, perform the following steps:

1. JSON stringify the object
2. Create an HMAC SHA256 hash of the stringified JSON object with your client signing secret
3. Base64 URL encode the raw hash data - this is your signature
4. Base64 URL encode your stringified JSON object - this is your payload
4. Concatenate the signature, a dot and the payload

See also [signed responses](/endpoints/#signed-responses), and signing in
[callback requests](/callbacks/), both of which use the same basic algorithm.
